podTemplate(containers: [



        containerTemplate(
        name: 'jnlp', 
        image: 'jenkins/inbound-agent:latest'
        ),
    containerTemplate(
        name: 'node', 
        image: 'node:latest', 
        command: 'sleep', 
        args: '30d')
  ],
  volumes: [
  persistentVolumeClaim(
      mountPath: '/home/jenkins/agent', 
      claimName: 'agent-workspace'      ),
  persistentVolumeClaim(
      mountPath: '/root/.npm', 
      claimName: 'node-npm'      )
  ]
  
  ) {
node(POD_LABEL) {
    environment {
            CI = 'true'
                }
    stage ('Git'){
            git url: 'https://github.com/younes-bami/node.git', branch: 'master'
    }
    stage ('Build'){
            container('node'){
			            sh '''
			            npm install
                  '''
                             }

    }
    stage('Test ') {                        
           container('node'){
                        sh '''
                         ./jenkins/scripts/test.sh
                           '''
                             }
    }

      


}
  }
podTemplate(yaml: readTrusted('pod.yaml')) {
  podTemplate(containers: [

      containerTemplate(
        name: 'skopeo', 
        image: 'quay.io/skopeo/stable:latest',
        command: 'sleep', 
        args: '30d'
        ),

  ]
  ){
  node(POD_LABEL) {
  environment {
            CI = 'true'
                }
  stage ('Git'){
            git url: 'https://github.com/younes-bami/node.git', branch: 'master'
    }
 stage('Artefact ') {                        
           container('buildah'){
                            sh "cd /home/jenkins/agent/workspace/${env.JOB_BASE_NAME}"
                            sh "buildah build   -t web-app:latest ."
                            sh "ls /var/lib/images"
                            

                             }
      
          container('skopeo'){
                          sh "skopeo-copy --dest-cred younesic:Dh123581321* dir:/var/lib/images/web-app docker://docker.io/younesic/web-app "
    
    }  
    }
}
}
}